<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFA - Sales Force Automation</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .sidebar-item:hover, .sidebar-item.active { background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%); }
        .card-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .table-row:hover { background-color: #f1f5f9; }
        input[type="file"] { display: none; }
        .custom-file-label { cursor: pointer; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-purple-700">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-chart-line text-white text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">SFA Pro</h1>
                <p class="text-gray-500">Sales Force Automation</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="loginUsername" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter username">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter password">
                </div>
                <button onclick="login()" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">
                    Sign In
                </button>
                <p class="text-center text-sm text-gray-500 mt-4">Demo: admin/admin123 or sales/sales123</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden flex min-h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-gray-900 text-white flex flex-col">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-line text-xl"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg">SFA Pro</h1>
                        <p class="text-xs text-gray-400" id="userRoleBadge">Admin</p>
                    </div>
                </div>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <div onclick="showSection('dashboard')" class="sidebar-item active flex items-center space-x-3 px-4 py-3 rounded-lg cursor-pointer transition">
                    <i class="fas fa-home w-5"></i><span>Dashboard</span>
                </div>
                <div onclick="showSection('outlets')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg cursor-pointer transition">
                    <i class="fas fa-store w-5"></i><span>Outlets</span>
                </div>
                <div onclick="showSection('skus')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg cursor-pointer transition">
                    <i class="fas fa-box w-5"></i><span>SKUs / Products</span>
                </div>
                <div onclick="showSection('sales')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg cursor-pointer transition">
                    <i class="fas fa-shopping-cart w-5"></i><span>Sales Orders</span>
                </div>
                <div onclick="showSection('visits')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg cursor-pointer transition">
                    <i class="fas fa-map-marker-alt w-5"></i><span>Visits</span>
                </div>
                <div id="usersNav" onclick="showSection('users')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg cursor-pointer transition">
                    <i class="fas fa-users w-5"></i><span>Users</span>
                </div>
                <div id="reportsNav" onclick="showSection('reports')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg cursor-pointer transition">
                    <i class="fas fa-chart-bar w-5"></i><span>Reports</span>
                </div>
            </nav>
            <div class="p-4 border-t border-gray-700">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <p class="font-medium" id="currentUserName">Admin User</p>
                        <p class="text-xs text-gray-400" id="currentUserEmail">admin@sfa.com</p>
                    </div>
                </div>
                <button onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 py-2 rounded-lg text-sm transition">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-auto">
            <!-- Header -->
            <header class="bg-white shadow-sm px-6 py-4 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800" id="pageTitle">Dashboard</h2>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-500" id="currentDate"></span>
                    <button class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                        <i class="fas fa-bell"></i>
                    </button>
                </div>
            </header>

            <!-- Dashboard Section -->
            <section id="dashboardSection" class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm opacity-80">Total Outlets</p>
                                <p class="text-3xl font-bold" id="statOutlets">0</p>
                            </div>
                            <i class="fas fa-store text-4xl opacity-50"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm opacity-80">Total SKUs</p>
                                <p class="text-3xl font-bold" id="statSKUs">0</p>
                            </div>
                            <i class="fas fa-box text-4xl opacity-50"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm opacity-80">Today's Sales</p>
                                <p class="text-3xl font-bold" id="statSales">$0</p>
                            </div>
                            <i class="fas fa-dollar-sign text-4xl opacity-50"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm opacity-80">Visits Today</p>
                                <p class="text-3xl font-bold" id="statVisits">0</p>
                            </div>
                            <i class="fas fa-map-marker-alt text-4xl opacity-50"></i>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Recent Sales Orders</h3>
                        <div id="recentSalesTable" class="overflow-x-auto">
                            <table class="w-full">
                                <thead><tr class="text-left text-gray-500 text-sm"><th class="pb-3">Order ID</th><th class="pb-3">Outlet</th><th class="pb-3">Amount</th><th class="pb-3">Status</th></tr></thead>
                                <tbody id="recentSalesBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Top Performing SKUs</h3>
                        <div id="topSKUsContainer"></div>
                    </div>
                </div>
            </section>

            <!-- Outlets Section -->
            <section id="outletsSection" class="p-6 hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <div class="flex gap-3">
                            <button onclick="openModal('outletModal')" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                                <i class="fas fa-plus mr-2"></i>Add Outlet
                            </button>
                            <label class="custom-file-label bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition cursor-pointer">
                                <i class="fas fa-file-excel mr-2"></i>Import Excel
                                <input type="file" id="outletExcelInput" accept=".xlsx,.xls" onchange="importOutletsExcel(event)">
                            </label>
                            <button onclick="exportOutletsExcel()" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition">
                                <i class="fas fa-download mr-2"></i>Export Excel
                            </button>
                        </div>
                        <input type="text" id="outletSearch" placeholder="Search outlets..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onkeyup="filterOutlets()">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50 text-left text-gray-600 text-sm">
                                    <th class="p-3 rounded-tl-lg">ID</th>
                                    <th class="p-3">Outlet Name</th>
                                    <th class="p-3">Owner</th>
                                    <th class="p-3">Phone</th>
                                    <th class="p-3">Address</th>
                                    <th class="p-3">Category</th>
                                    <th class="p-3">Status</th>
                                    <th class="p-3 rounded-tr-lg">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="outletsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- SKUs Section -->
            <section id="skusSection" class="p-6 hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <div class="flex gap-3">
                            <button onclick="openModal('skuModal')" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                                <i class="fas fa-plus mr-2"></i>Add SKU
                            </button>
                            <label class="custom-file-label bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition cursor-pointer">
                                <i class="fas fa-file-excel mr-2"></i>Import Excel
                                <input type="file" id="skuExcelInput" accept=".xlsx,.xls" onchange="importSKUsExcel(event)">
                            </label>
                            <button onclick="exportSKUsExcel()" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition">
                                <i class="fas fa-download mr-2"></i>Export Excel
                            </button>
                        </div>
                        <input type="text" id="skuSearch" placeholder="Search SKUs..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onkeyup="filterSKUs()">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50 text-left text-gray-600 text-sm">
                                    <th class="p-3 rounded-tl-lg">SKU Code</th>
                                    <th class="p-3">Product Name</th>
                                    <th class="p-3">Category</th>
                                    <th class="p-3">Price</th>
                                    <th class="p-3">Stock</th>
                                    <th class="p-3">Status</th>
                                    <th class="p-3 rounded-tr-lg">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="skusTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Sales Section -->
            <section id="salesSection" class="p-6 hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <button onclick="openModal('salesModal')" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                            <i class="fas fa-plus mr-2"></i>New Sale Order
                        </button>
                        <div class="flex gap-3">
                            <input type="date" id="salesDateFilter" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="filterSales()">
                            <select id="salesStatusFilter" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="filterSales()">
                                <option value="">All Status</option>
                                <option value="Pending">Pending</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50 text-left text-gray-600 text-sm">
                                    <th class="p-3">Order ID</th>
                                    <th class="p-3">Date</th>
                                    <th class="p-3">Outlet</th>
                                    <th class="p-3">Sales Person</th>
                                    <th class="p-3">Items</th>
                                    <th class="p-3">Total</th>
                                    <th class="p-3">Status</th>
                                    <th class="p-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Visits Section -->
            <section id="visitsSection" class="p-6 hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <button onclick="openModal('visitModal')" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                            <i class="fas fa-plus mr-2"></i>Log Visit
                        </button>
                        <input type="date" id="visitDateFilter" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="filterVisits()">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50 text-left text-gray-600 text-sm">
                                    <th class="p-3">Visit ID</th>
                                    <th class="p-3">Date/Time</th>
                                    <th class="p-3">Outlet</th>
                                    <th class="p-3">Sales Person</th>
                                    <th class="p-3">Purpose</th>
                                    <th class="p-3">Notes</th>
                                    <th class="p-3">Status</th>
                                </tr>
                            </thead>
                            <tbody id="visitsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Users Section -->
            <section id="usersSection" class="p-6 hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <button onclick="openModal('userModal')" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                            <i class="fas fa-plus mr-2"></i>Add User
                        </button>
                        <select id="userRoleFilter" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="filterUsers()">
                            <option value="">All Roles</option>
                            <option value="admin">Admin</option>
                            <option value="sales">Sales</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50 text-left text-gray-600 text-sm">
                                    <th class="p-3">ID</th>
                                    <th class="p-3">Name</th>
                                    <th class="p-3">Email</th>
                                    <th class="p-3">Phone</th>
                                    <th class="p-3">Role</th>
                                    <th class="p-3">Status</th>
                                    <th class="p-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reportsSection" class="p-6 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Sales by Category</h3>
                        <div id="categoryReport" class="space-y-3"></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Sales Performance</h3>
                        <div id="performanceReport" class="space-y-3"></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 md:col-span-2">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Monthly Sales Trend</h3>
                        <div id="monthlyTrend" class="flex items-end justify-between h-48 gap-2"></div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Outlet Modal -->
    <div id="outletModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 invisible opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold" id="outletModalTitle">Add Outlet</h3>
                <button onclick="closeModal('outletModal')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="outletForm" class="p-6 space-y-4">
                <input type="hidden" id="outletId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Outlet Name *</label>
                    <input type="text" id="outletName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Owner Name *</label>
                    <input type="text" id="outletOwner" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                    <input type="tel" id="outletPhone" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Address *</label>
                    <textarea id="outletAddress" required rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category *</label>
                    <select id="outletCategory" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Category</option>
                        <option value="Retail">Retail</option>
                        <option value="Wholesale">Wholesale</option>
                        <option value="Supermarket">Supermarket</option>
                        <option value="Convenience">Convenience Store</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="outletStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition">Save Outlet</button>
            </form>
        </div>
    </div>

    <!-- SKU Modal -->
    <div id="skuModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 invisible opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold" id="skuModalTitle">Add SKU</h3>
                <button onclick="closeModal('skuModal')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="skuForm" class="p-6 space-y-4">
                <input type="hidden" id="skuId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">SKU Code *</label>
                    <input type="text" id="skuCode" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Product Name *</label>
                    <input type="text" id="skuName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category *</label>
                    <select id="skuCategory" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Category</option>
                        <option value="Beverages">Beverages</option>
                        <option value="Snacks">Snacks</option>
                        <option value="Dairy">Dairy</option>
                        <option value="Personal Care">Personal Care</option>
                        <option value="Household">Household</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Price *</label>
                        <input type="number" id="skuPrice" required step="0.01" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Stock *</label>
                        <input type="number" id="skuStock" required min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="skuStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition">Save SKU</button>
            </form>
        </div>
    </div>

    <!-- Sales Modal -->
    <div id="salesModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 invisible opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">New Sales Order</h3>
                <button onclick="closeModal('salesModal')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="salesForm" class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Outlet *</label>
                        <select id="salesOutlet" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date *</label>
                        <input type="date" id="salesDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Order Items</label>
                    <div id="orderItems" class="space-y-2"></div>
                    <button type="button" onclick="addOrderItem()" class="mt-2 text-blue-500 hover:text-blue-700"><i class="fas fa-plus mr-1"></i>Add Item</button>
                </div>
                <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg">
                    <span class="font-bold">Total:</span>
                    <span class="text-2xl font-bold text-blue-600" id="orderTotal">$0.00</span>
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition">Create Order</button>
            </form>
        </div>
    </div>

    <!-- Visit Modal -->
    <div id="visitModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 invisible opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Log Visit</h3>
                <button onclick="closeModal('visitModal')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="visitForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Outlet *</label>
                    <select id="visitOutlet" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Purpose *</label>
                    <select id="visitPurpose" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Purpose</option>
                        <option value="Sales Call">Sales Call</option>
                        <option value="Order Collection">Order Collection</option>
                        <option value="Payment Collection">Payment Collection</option>
                        <option value="New Product Introduction">New Product Introduction</option>
                        <option value="Complaint Resolution">Complaint Resolution</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                    <textarea id="visitNotes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition">Log Visit</button>
            </form>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 invisible opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold" id="userModalTitle">Add User</h3>
                <button onclick="closeModal('userModal')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="userForm" class="p-6 space-y-4">
                <input type="hidden" id="userId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                    <input type="text" id="userName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                    <input type="email" id="userEmail" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                    <input type="tel" id="userPhone" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Username *</label>
                    <input type="text" id="userUsername" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div id="passwordField">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                    <input type="password" id="userPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Role *</label>
                    <select id="userRole" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="sales">Sales Personnel</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="userStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition">Save User</button>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300">
        <span id="toastMessage">Success!</span>
    </div>

    <script>
        // Data Storage
        let currentUser = null;
        let data = {
            users: [
                { id: 1, name: 'Admin User', email: 'admin@sfa.com', phone: '123-456-7890', username: 'admin', password: 'admin123', role: 'admin', status: 'Active' },
                { id: 2, name: 'John Sales', email: 'john@sfa.com', phone: '123-456-7891', username: 'sales', password: 'sales123', role: 'sales', status: 'Active' },
                { id: 3, name: 'Sarah Rep', email: 'sarah@sfa.com', phone: '123-456-7892', username: 'sarah', password: 'sarah123', role: 'sales', status: 'Active' }
            ],
            outlets: [
                { id: 1, name: 'Metro Mart', owner: 'Mike Johnson', phone: '555-0101', address: '123 Main St, City', category: 'Supermarket', status: 'Active' },
                { id: 2, name: 'Quick Stop', owner: 'Lisa Chen', phone: '555-0102', address: '456 Oak Ave, Town', category: 'Convenience', status: 'Active' },
                { id: 3, name: 'Mega Wholesale', owner: 'Bob Smith', phone: '555-0103', address: '789 Industrial Blvd', category: 'Wholesale', status: 'Active' }
            ],
            skus: [
                { id: 1, code: 'SKU001', name: 'Cola 500ml', category: 'Beverages', price: 2.50, stock: 500, status: 'Active' },
                { id: 2, code: 'SKU002', name: 'Chips Family Pack', category: 'Snacks', price: 4.99, stock: 300, status: 'Active' },
                { id: 3, code: 'SKU003', name: 'Fresh Milk 1L', category: 'Dairy', price: 3.25, stock: 200, status: 'Active' },
                { id: 4, code: 'SKU004', name: 'Hand Soap 250ml', category: 'Personal Care', price: 5.50, stock: 150, status: 'Active' }
            ],
            sales: [
                { id: 1001, date: '2024-01-15', outletId: 1, salesPerson: 'John Sales', items: [{skuId: 1, qty: 20}, {skuId: 2, qty: 10}], total: 99.90, status: 'Completed' },
                { id: 1002, date: '2024-01-15', outletId: 2, salesPerson: 'Sarah Rep', items: [{skuId: 3, qty: 15}], total: 48.75, status: 'Pending' }
            ],
            visits: [
                { id: 1, datetime: '2024-01-15 09:30', outletId: 1, salesPerson: 'John Sales', purpose: 'Sales Call', notes: 'Discussed new products', status: 'Completed' },
                { id: 2, datetime: '2024-01-15 11:00', outletId: 2, salesPerson: 'Sarah Rep', purpose: 'Order Collection', notes: 'Collected weekly order', status: 'Completed' }
            ]
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromStorage();
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('salesDate').valueAsDate = new Date();
            setupFormListeners();
        });

        function loadDataFromStorage() {
            const stored = localStorage.getItem('sfaData');
            if (stored) data = JSON.parse(stored);
        }

        function saveData() {
            localStorage.setItem('sfaData', JSON.stringify(data));
        }

        // Authentication
        function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const user = data.users.find(u => u.username === username && u.password === password && u.status === 'Active');
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('currentUserName').textContent = user.name;
                document.getElementById('currentUserEmail').textContent = user.email;
                document.getElementById('userRoleBadge').textContent = user.role === 'admin' ? 'Admin' : 'Sales Personnel';
                if (user.role !== 'admin') {
                    document.getElementById('usersNav').classList.add('hidden');
                }
                showSection('dashboard');
                showToast('Welcome back, ' + user.name + '!');
            } else {
                showToast('Invalid credentials!', 'error');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // Navigation
        function showSection(section) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(section + 'Section').classList.remove('hidden');
            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.sidebar-item')?.classList.add('active');
            document.getElementById('pageTitle').textContent = section.charAt(0).toUpperCase() + section.slice(1);
            
            switch(section) {
                case 'dashboard': updateDashboard(); break;
                case 'outlets': renderOutlets(); break;
                case 'skus': renderSKUs(); break;
                case 'sales': renderSales(); break;
                case 'visits': renderVisits(); break;
                case 'users': renderUsers(); break;
                case 'reports': renderReports(); break;
            }
        }

        // Dashboard
        function updateDashboard() {
            document.getElementById('statOutlets').textContent = data.outlets.length;
            document.getElementById('statSKUs').textContent = data.skus.length;
            const todaySales = data.sales.filter(s => s.date === new Date().toISOString().split('T')[0]).reduce((sum, s) => sum + s.total, 0);
            document.getElementById('statSales').textContent = '$' + todaySales.toFixed(2);
            const todayVisits = data.visits.filter(v => v.datetime.startsWith(new Date().toISOString().split('T')[0])).length;
            document.getElementById('statVisits').textContent = todayVisits;

            // Recent Sales
            const recentSales = data.sales.slice(-5).reverse();
            document.getElementById('recentSalesBody').innerHTML = recentSales.map(sale => {
                const outlet = data.outlets.find(o => o.id === sale.outletId);
                return `<tr class="border-b"><td class="py-2">#${sale.id}</td><td>${outlet?.name || 'N/A'}</td><td>$${sale.total.toFixed(2)}</td><td><span class="px-2 py-1 rounded-full text-xs ${sale.status === 'Completed' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">${sale.status}</span></td></tr>`;
            }).join('');

            // Top SKUs
            const skuSales = {};
            data.sales.forEach(sale => {
                sale.items.forEach(item => {
                    skuSales[item.skuId] = (skuSales[item.skuId] || 0) + item.qty;
                });
            });
            const topSKUs = Object.entries(skuSales).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const maxQty = topSKUs[0]?.[1] || 1;
            document.getElementById('topSKUsContainer').innerHTML = topSKUs.map(([skuId, qty]) => {
                const sku = data.skus.find(s => s.id == skuId);
                const width = (qty / maxQty) * 100;
                return `<div class="mb-3"><div class="flex justify-between text-sm mb-1"><span>${sku?.name || 'Unknown'}</span><span class="font-bold">${qty} units</span></div><div class="h-2 bg-gray-200 rounded-full"><div class="h-2 bg-blue-500 rounded-full" style="width: ${width}%"></div></div></div>`;
            }).join('') || '<p class="text-gray-500">No sales data yet</p>';
        }

        // Outlets
        function renderOutlets() {
            document.getElementById('outletsTableBody').innerHTML = data.outlets.map(outlet => `
                <tr class="table-row border-b">
                    <td class="p-3">${outlet.id}</td>
                    <td class="p-3 font-medium">${outlet.name}</td>
                    <td class="p-3">${outlet.owner}</td>
                    <td class="p-3">${outlet.phone}</td>
                    <td class="p-3">${outlet.address}</td>
                    <td class="p-3"><span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs">${outlet.category}</span></td>
                    <td class="p-3"><span class="px-2 py-1 rounded-full text-xs ${outlet.status === 'Active' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${outlet.status}</span></td>
                    <td class="p-3">
                        <button onclick="editOutlet(${outlet.id})" class="text-blue-500 hover:text-blue-700 mr-2"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteOutlet(${outlet.id})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function editOutlet(id) {
            const outlet = data.outlets.find(o => o.id === id);
            if (outlet) {
                document.getElementById('outletModalTitle').textContent = 'Edit Outlet';
                document.getElementById('outletId').value = outlet.id;
                document.getElementById('outletName').value = outlet.name;
                document.getElementById('outletOwner').value = outlet.owner;
                document.getElementById('outletPhone').value = outlet.phone;
                document.getElementById('outletAddress').value = outlet.address;
                document.getElementById('outletCategory').value = outlet.category;
                document.getElementById('outletStatus').value = outlet.status;
                openModal('outletModal');
            }
        }

        function deleteOutlet(id) {
            if (confirm('Are you sure you want to delete this outlet?')) {
                data.outlets = data.outlets.filter(o => o.id !== id);
                saveData();
                renderOutlets();
                showToast('Outlet deleted successfully!');
            }
        }

        function filterOutlets() {
            const search = document.getElementById('outletSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#outletsTableBody tr');
            rows.forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(search) ? '' : 'none';
            });
        }

        function importOutletsExcel(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const workbook = XLSX.read(e.target.result, { type: 'binary' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet);
                let count = 0;
                jsonData.forEach(row => {
                    const existing = data.outlets.find(o => o.name === row.name || o.name === row.Name);
                    if (existing) {
                        Object.assign(existing, {
                            name: row.name || row.Name || existing.name,
                            owner: row.owner || row.Owner || existing.owner,
                            phone: row.phone || row.Phone || existing.phone,
                            address: row.address || row.Address || existing.address,
                            category: row.category || row.Category || existing.category,
                            status: row.status || row.Status || existing.status
                        });
                    } else {
                        data.outlets.push({
                            id: Math.max(...data.outlets.map(o => o.id), 0) + 1,
                            name: row.name || row.Name || '',
                            owner: row.owner || row.Owner || '',
                            phone: row.phone || row.Phone || '',
                            address: row.address || row.Address || '',
                            category: row.category || row.Category || 'Retail',
                            status: row.status || row.Status || 'Active'
                        });
                        count++;
                    }
                });
                saveData();
                renderOutlets();
                showToast(`Imported/Updated ${jsonData.length} outlets!`);
            };
            reader.readAsBinaryString(file);
            event.target.value = '';
        }

        function exportOutletsExcel() {
            const ws = XLSX.utils.json_to_sheet(data.outlets);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Outlets');
            XLSX.writeFile(wb, 'outlets.xlsx');
            showToast('Outlets exported successfully!');
        }

        // SKUs
        function renderSKUs() {
            document.getElementById('skusTableBody').innerHTML = data.skus.map(sku => `
                <tr class="table-row border-b">
                    <td class="p-3 font-mono">${sku.code}</td>
                    <td class="p-3 font-medium">${sku.name}</td>
                    <td class="p-3"><span class="px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs">${sku.category}</span></td>
                    <td class="p-3">$${sku.price.toFixed(2)}</td>
                    <td class="p-3">${sku.stock}</td>
                    <td class="p-3"><span class="px-2 py-1 rounded-full text-xs ${sku.status === 'Active' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${sku.status}</span></td>
                    <td class="p-3">
                        <button onclick="editSKU(${sku.id})" class="text-blue-500 hover:text-blue-700 mr-2"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteSKU(${sku.id})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function editSKU(id) {
            const sku = data.skus.find(s => s.id === id);
            if (sku) {
                document.getElementById('skuModalTitle').textContent = 'Edit SKU';
                document.getElementById('skuId').value = sku.id;
                document.getElementById('skuCode').value = sku.code;
                document.getElementById('skuName').value = sku.name;
                document.getElementById('skuCategory').value = sku.category;
                document.getElementById('skuPrice').value = sku.price;
                document.getElementById('skuStock').value = sku.stock;
                document.getElementById('skuStatus').value = sku.status;
                openModal('skuModal');
            }
        }

        function deleteSKU(id) {
            if (confirm('Are you sure you want to delete this SKU?')) {
                data.skus = data.skus.filter(s => s.id !== id);
                saveData();
                renderSKUs();
                showToast('SKU deleted successfully!');
            }
        }

        function filterSKUs() {
            const search = document.getElementById('skuSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#skusTableBody tr');
            rows.forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(search) ? '' : 'none';
            });
        }

        function importSKUsExcel(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const workbook = XLSX.read(e.target.result, { type: 'binary' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet);
                jsonData.forEach(row => {
                    const existing = data.skus.find(s => s.code === row.code || s.code === row.Code || s.code === row.SKUCode);
                    if (existing) {
                        Object.assign(existing, {
                            code: row.code || row.Code || row.SKUCode || existing.code,
                            name: row.name || row.Name || row.ProductName || existing.name,
                            category: row.category || row.Category || existing.category,
                            price: parseFloat(row.price || row.Price) || existing.price,
                            stock: parseInt(row.stock || row.Stock) || existing.stock,
                            status: row.status || row.Status || existing.status
                        });
                    } else {
                        data.skus.push({
                            id: Math.max(...data.skus.map(s => s.id), 0) + 1,
                            code: row.code || row.Code || row.SKUCode || '',
                            name: row.name || row.Name || row.ProductName || '',
                            category: row.category || row.Category || 'Beverages',
                            price: parseFloat(row.price || row.Price) || 0,
                            stock: parseInt(row.stock || row.Stock) || 0,
                            status: row.status || row.Status || 'Active'
                        });
                    }
                });
                saveData();
                renderSKUs();
                showToast(`Imported/Updated ${jsonData.length} SKUs!`);
            };
            reader.readAsBinaryString(file);
            event.target.value = '';
        }

        function exportSKUsExcel() {
            const ws = XLSX.utils.json_to_sheet(data.skus);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'SKUs');
            XLSX.writeFile(wb, 'skus.xlsx');
            showToast('SKUs exported successfully!');
        }

        // Sales
        function renderSales() {
            populateOutletDropdowns();
            document.getElementById('salesTableBody').innerHTML = data.sales.map(sale => {
                const outlet = data.outlets.find(o => o.id === sale.outletId);
                return `
                    <tr class="table-row border-b">
                        <td class="p-3 font-mono">#${sale.id}</td>
                        <td class="p-3">${sale.date}</td>
                        <td class="p-3 font-medium">${outlet?.name || 'N/A'}</td>
                        <td class="p-3">${sale.salesPerson}</td>
                        <td class="p-3">${sale.items.length} items</td>
                        <td class="p-3 font-bold">$${sale.total.toFixed(2)}</td>
                        <td class="p-3"><span class="px-2 py-1 rounded-full text-xs ${sale.status === 'Completed' ? 'bg-green-100 text-green-700' : sale.status === 'Pending' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}">${sale.status}</span></td>
                        <td class="p-3">
                            <button onclick="viewSale(${sale.id})" class="text-blue-500 hover:text-blue-700 mr-2"><i class="fas fa-eye"></i></button>
                            ${sale.status === 'Pending' ? `<button onclick="completeSale(${sale.id})" class="text-green-500 hover:text-green-700"><i class="fas fa-check"></i></button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function completeSale(id) {
            const sale = data.sales.find(s => s.id === id);
            if (sale) {
                sale.status = 'Completed';
                saveData();
                renderSales();
                showToast('Sale marked as completed!');
            }
        }

        function viewSale(id) {
            const sale = data.sales.find(s => s.id === id);
            if (sale) {
                const outlet = data.outlets.find(o => o.id === sale.outletId);
                const itemDetails = sale.items.map(item => {
                    const sku = data.skus.find(s => s.id === item.skuId);
                    return `${sku?.name || 'Unknown'} x ${item.qty}`;
                }).join('\n');
                alert(`Order #${sale.id}\nOutlet: ${outlet?.name}\nDate: ${sale.date}\nItems:\n${itemDetails}\nTotal: $${sale.total.toFixed(2)}\nStatus: ${sale.status}`);
            }
        }

        function filterSales() {
            const dateFilter = document.getElementById('salesDateFilter').value;
            const statusFilter = document.getElementById('salesStatusFilter').value;
            const rows = document.querySelectorAll('#salesTableBody tr');
            rows.forEach((row, i) => {
                const sale = data.sales[i];
                const dateMatch = !dateFilter || sale.date === dateFilter;
                const statusMatch = !statusFilter || sale.status === statusFilter;
                row.style.display = dateMatch && statusMatch ? '' : 'none';
            });
        }

        function populateOutletDropdowns() {
            const options = data.outlets.filter(o => o.status === 'Active').map(o => `<option value="${o.id}">${o.name}</option>`).join('');
            document.getElementById('salesOutlet').innerHTML = '<option value="">Select Outlet</option>' + options;
            document.getElementById('visitOutlet').innerHTML = '<option value="">Select Outlet</option>' + options;
        }

        function addOrderItem() {
            const container = document.getElementById('orderItems');
            const skuOptions = data.skus.filter(s => s.status === 'Active').map(s => `<option value="${s.id}" data-price="${s.price}">${s.name} - $${s.price.toFixed(2)}</option>`).join('');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex gap-2 items-center';
            itemDiv.innerHTML = `
                <select class="flex-1 px-3 py-2 border border-gray-300 rounded-lg item-sku" onchange="updateOrderTotal()">
                    <option value="">Select SKU</option>${skuOptions}
                </select>
                <input type="number" min="1" value="1" class="w-20 px-3 py-2 border border-gray-300 rounded-lg item-qty" onchange="updateOrderTotal()">
                <button type="button" onclick="this.parentElement.remove(); updateOrderTotal();" class="text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(itemDiv);
        }

        function updateOrderTotal() {
            let total = 0;
            document.querySelectorAll('#orderItems > div').forEach(item => {
                const select = item.querySelector('.item-sku');
                const qty = parseInt(item.querySelector('.item-qty').value) || 0;
                const price = parseFloat(select.selectedOptions[0]?.dataset.price) || 0;
                total += price * qty;
            });
            document.getElementById('orderTotal').textContent = '$' + total.toFixed(2);
        }

        // Visits
        function renderVisits() {
            populateOutletDropdowns();
            document.getElementById('visitsTableBody').innerHTML = data.visits.map(visit => {
                const outlet = data.outlets.find(o => o.id === visit.outletId);
                return `
                    <tr class="table-row border-b">
                        <td class="p-3">${visit.id}</td>
                        <td class="p-3">${visit.datetime}</td>
                        <td class="p-3 font-medium">${outlet?.name || 'N/A'}</td>
                        <td class="p-3">${visit.salesPerson}</td>
                        <td class="p-3"><span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs">${visit.purpose}</span></td>
                        <td class="p-3">${visit.notes || '-'}</td>
                        <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs">${visit.status}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function filterVisits() {
            const dateFilter = document.getElementById('visitDateFilter').value;
            const rows = document.querySelectorAll('#visitsTableBody tr');
            rows.forEach((row, i) => {
                const visit = data.visits[i];
                row.style.display = !dateFilter || visit.datetime.startsWith(dateFilter) ? '' : 'none';
            });
        }

        // Users
        function renderUsers() {
            if (currentUser?.role !== 'admin') {
                showSection('dashboard');
                return;
            }
            document.getElementById('usersTableBody').innerHTML = data.users.map(user => `
                <tr class="table-row border-b">
                    <td class="p-3">${user.id}</td>
                    <td class="p-3 font-medium">${user.name}</td>
                    <td class="p-3">${user.email}</td>
                    <td class="p-3">${user.phone}</td>
                    <td class="p-3"><span class="px-2 py-1 rounded-full text-xs ${user.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}">${user.role === 'admin' ? 'Admin' : 'Sales'}</span></td>
                    <td class="p-3"><span class="px-2 py-1 rounded-full text-xs ${user.status === 'Active' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${user.status}</span></td>
                    <td class="p-3">
                        <button onclick="editUser(${user.id})" class="text-blue-500 hover:text-blue-700 mr-2"><i class="fas fa-edit"></i></button>
                        ${user.id !== currentUser.id ? `<button onclick="deleteUser(${user.id})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function editUser(id) {
            const user = data.users.find(u => u.id === id);
            if (user) {
                document.getElementById('userModalTitle').textContent = 'Edit User';
                document.getElementById('userId').value = user.id;
                document.getElementById('userName').value = user.name;
                document.getElementById('userEmail').value = user.email;
                document.getElementById('userPhone').value = user.phone;
                document.getElementById('userUsername').value = user.username;
                document.getElementById('userPassword').value = '';
                document.getElementById('userRole').value = user.role;
                document.getElementById('userStatus').value = user.status;
                document.getElementById('passwordField').querySelector('label').textContent = 'Password (leave blank to keep current)';
                openModal('userModal');
            }
        }

        function deleteUser(id) {
            if (confirm('Are you sure you want to delete this user?')) {
                data.users = data.users.filter(u => u.id !== id);
                saveData();
                renderUsers();
                showToast('User deleted successfully!');
            }
        }

        function filterUsers() {
            const roleFilter = document.getElementById('userRoleFilter').value;
            const rows = document.querySelectorAll('#usersTableBody tr');
            rows.forEach((row, i) => {
                const user = data.users[i];
                row.style.display = !roleFilter || user.role === roleFilter ? '' : 'none';
            });
        }

        // Reports
        function renderReports() {
            // Category Report
            const categoryTotals = {};
            data.sales.forEach(sale => {
                sale.items.forEach(item => {
                    const sku = data.skus.find(s => s.id === item.skuId);
                    if (sku) {
                        categoryTotals[sku.category] = (categoryTotals[sku.category] || 0) + (item.qty * sku.price);
                    }
                });
            });
            const maxCatTotal = Math.max(...Object.values(categoryTotals), 1);
            document.getElementById('categoryReport').innerHTML = Object.entries(categoryTotals).map(([cat, total]) => `
                <div><div class="flex justify-between text-sm mb-1"><span>${cat}</span><span class="font-bold">$${total.toFixed(2)}</span></div>
                <div class="h-3 bg-gray-200 rounded-full"><div class="h-3 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full" style="width: ${(total/maxCatTotal)*100}%"></div></div></div>
            `).join('') || '<p class="text-gray-500">No data</p>';

            // Performance Report
            const personTotals = {};
            data.sales.forEach(sale => {
                personTotals[sale.salesPerson] = (personTotals[sale.salesPerson] || 0) + sale.total;
            });
            const maxPersonTotal = Math.max(...Object.values(personTotals), 1);
            document.getElementById('performanceReport').innerHTML = Object.entries(personTotals).sort((a,b) => b[1]-a[1]).map(([person, total]) => `
                <div><div class="flex justify-between text-sm mb-1"><span>${person}</span><span class="font-bold">$${total.toFixed(2)}</span></div>
                <div class="h-3 bg-gray-200 rounded-full"><div class="h-3 bg-gradient-to-r from-green-500 to-teal-500 rounded-full" style="width: ${(total/maxPersonTotal)*100}%"></div></div></div>
            `).join('') || '<p class="text-gray-500">No data</p>';

            // Monthly Trend
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthlyData = new Array(12).fill(0);
            data.sales.forEach(sale => {
                const month = new Date(sale.date).getMonth();
                monthlyData[month] += sale.total;
            });
            const maxMonthly = Math.max(...monthlyData, 1);
            document.getElementById('monthlyTrend').innerHTML = months.map((m, i) => `
                <div class="flex-1 flex flex-col items-center">
                    <div class="w-full bg-gradient-to-t from-blue-500 to-purple-500 rounded-t" style="height: ${(monthlyData[i]/maxMonthly)*100}%"></div>
                    <span class="text-xs mt-2 text-gray-500">${m}</span>
                </div>
            `).join('');
        }

        // Modal Functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('invisible', 'opacity-0');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('invisible', 'opacity-0');
            if (modalId === 'outletModal') {
                document.getElementById('outletForm').reset();
                document.getElementById('outletId').value = '';
                document.getElementById('outletModalTitle').textContent = 'Add Outlet';
            } else if (modalId === 'skuModal') {
                document.getElementById('skuForm').reset();
                document.getElementById('skuId').value = '';
                document.getElementById('skuModalTitle').textContent = 'Add SKU';
            } else if (modalId === 'salesModal') {
                document.getElementById('salesForm').reset();
                document.getElementById('orderItems').innerHTML = '';
                document.getElementById('orderTotal').textContent = '$0.00';
            } else if (modalId === 'userModal') {
                document.getElementById('userForm').reset();
                document.getElementById('userId').value = '';
                document.getElementById('userModalTitle').textContent = 'Add User';
                document.getElementById('passwordField').querySelector('label').textContent = 'Password *';
            }
        }

        // Form Listeners
        function setupFormListeners() {
            document.getElementById('outletForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const id = document.getElementById('outletId').value;
                const outletData = {
                    name: document.getElementById('outletName').value,
                    owner: document.getElementById('outletOwner').value,
                    phone: document.getElementById('outletPhone').value,
                    address: document.getElementById('outletAddress').value,
                    category: document.getElementById('outletCategory').value,
                    status: document.getElementById('outletStatus').value
                };
                if (id) {
                    const outlet = data.outlets.find(o => o.id == id);
                    Object.assign(outlet, outletData);
                } else {
                    outletData.id = Math.max(...data.outlets.map(o => o.id), 0) + 1;
                    data.outlets.push(outletData);
                }
                saveData();
                closeModal('outletModal');
                renderOutlets();
                showToast(id ? 'Outlet updated!' : 'Outlet added!');
            });

            document.getElementById('skuForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const id = document.getElementById('skuId').value;
                const skuData = {
                    code: document.getElementById('skuCode').value,
                    name: document.getElementById('skuName').value,
                    category: document.getElementById('skuCategory').value,
                    price: parseFloat(document.getElementById('skuPrice').value),
                    stock: parseInt(document.getElementById('skuStock').value),
                    status: document.getElementById('skuStatus').value
                };
                if (id) {
                    const sku = data.skus.find(s => s.id == id);
                    Object.assign(sku, skuData);
                } else {
                    skuData.id = Math.max(...data.skus.map(s => s.id), 0) + 1;
                    data.skus.push(skuData);
                }
                saveData();
                closeModal('skuModal');
                renderSKUs();
                showToast(id ? 'SKU updated!' : 'SKU added!');
            });

            document.getElementById('salesForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const items = [];
                document.querySelectorAll('#orderItems > div').forEach(item => {
                    const skuId = parseInt(item.querySelector('.item-sku').value);
                    const qty = parseInt(item.querySelector('.item-qty').value);
                    if (skuId && qty) items.push({ skuId, qty });
                });
                if (items.length === 0) {
                    showToast('Please add at least one item!', 'error');
                    return;
                }
                let total = 0;
                items.forEach(item => {
                    const sku = data.skus.find(s => s.id === item.skuId);
                    if (sku) total += sku.price * item.qty;
                });
                data.sales.push({
                    id: Math.max(...data.sales.map(s => s.id), 1000) + 1,
                    date: document.getElementById('salesDate').value,
                    outletId: parseInt(document.getElementById('salesOutlet').value),
                    salesPerson: currentUser.name,
                    items,
                    total,
                    status: 'Pending'
                });
                saveData();
                closeModal('salesModal');
                renderSales();
                showToast('Sales order created!');
            });

            document.getElementById('visitForm').addEventListener('submit', function(e) {
                e.preventDefault();
                data.visits.push({
                    id: Math.max(...data.visits.map(v => v.id), 0) + 1,
                    datetime: new Date().toISOString().slice(0, 16).replace('T', ' '),
                    outletId: parseInt(document.getElementById('visitOutlet').value),
                    salesPerson: currentUser.name,
                    purpose: document.getElementById('visitPurpose').value,
                    notes: document.getElementById('visitNotes').value,
                    status: 'Completed'
                });
                saveData();
                closeModal('visitModal');
                renderVisits();
                showToast('Visit logged!');
            });

            document.getElementById('userForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const id = document.getElementById('userId').value;
                const userData = {
                    name: document.getElementById('userName').value,
                    email: document.getElementById('userEmail').value,
                    phone: document.getElementById('userPhone').value,
                    username: document.getElementById('userUsername').value,
                    role: document.getElementById('userRole').value,
                    status: document.getElementById('userStatus').value
                };
                const password = document.getElementById('userPassword').value;
                if (id) {
                    const user = data.users.find(u => u.id == id);
                    Object.assign(user, userData);
                    if (password) user.password = password;
                } else {
                    if (!password) {
                        showToast('Password is required!', 'error');
                        return;
                    }
                    userData.id = Math.max(...data.users.map(u => u.id), 0) + 1;
                    userData.password = password;
                    data.users.push(userData);
                }
                saveData();
                closeModal('userModal');
                renderUsers();
                showToast(id ? 'User updated!' : 'User added!');
            });
        }

        // Toast Notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toast.className = `fixed bottom-4 right-4 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} text-white px-6 py-3 rounded-lg shadow-lg transition-all duration-300`;
            toastMessage.textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }
    </script>
</body>
</html>
